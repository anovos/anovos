#!/bin/bash

machine_type="$1"
node_count="$2"


aws emr create-cluster --applications Name=Hive Name=Spark Name=TensorFlow Name=Hadoop --tags 'AUTO_NAME=mw_engr_anovos' 'AUTO_TYPE=EMR' 'Name=mw_engr_anovos' --ec2-attributes '{"KeyName":"mw","InstanceProfile":"emr-ec2-defaultrole","ServiceAccessSecurityGroup":"sg-0eac20a5c0142d31f","SubnetId":"subnet-00ed9fd09a9117fec","EmrManagedSlaveSecurityGroup":"sg-07d6ffde90ed91a53","EmrManagedMasterSecurityGroup":"sg-03019904b1427e7ad","AdditionalMasterSecurityGroups":["sg-0334a0e33c482cf54"]}' --release-label emr-5.33.0 --log-uri 's3n://aws-logs-361166629815-us-east-1/elasticmapreduce/' --steps '[{"Args":["spark-submit","--deploy-mode","client","--num-executors","1000","--executor-cores","4","--executor-memory","30g","--driver-memory","30G","--driver-cores","4","--conf","spark.driver.maxResultSize=25g","--conf","spark.yarn.am.memoryOverhead=1000m","--conf","spark.executor.memoryOverhead=2000m","--conf","spark.kryo.referenceTracking=false","--conf","spark.network.timeout=18000s","--conf","spark.executor.heartbeatInterval=12000s","--conf","spark.dynamicAllocation.executorIdleTimeout=12000s","--conf","spark.rpc.message.maxSize=2047","--conf","spark.yarn.maxAppAttempts=1","--conf","spark.speculation=false","--conf","spark.kryoserializer.buffer.max=1024","--conf","spark.executor.extraJavaOptions=-XX:+UseG1GC","--conf","spark.driver.extraJavaOptions=-XX:+UseG1GC","--packages","org.apache.spark:spark-avro_2.11:2.4.7","--jars","s3://mw.test/krish/anovos/general/resources/jars/histogrammar_2.11-1.0.20.jar,s3://mw.test/krish/anovos/general/resources/jars/histogrammar-sparksql_2.11-1.0.20.jar","--py-files","s3://mw.test/krish/anovos/general/resources/anovos.zip","s3://mw.test/krish/anovos/general/resources/main.py","s3://mw.test/krish/anovos/ieee_fraud_detection/configs_v2/configs_ieee_fraud.yaml","emr"],"Type":"CUSTOM_JAR","ActionOnFailure":"CONTINUE","Jar":"command-runner.jar","Properties":"","Name":"anovos_time_stats_ieee_fraud"}]' --instance-groups '[{"'$node_count'":1,"EbsConfiguration":{"EbsBlockDeviceConfigs":[{"VolumeSpecification":{"SizeInGB":800,"VolumeType":"gp2"},"VolumesPerInstance":1}],"EbsOptimized":true},"InstanceGroupType":"CORE","InstanceType":"'$machine_type'","Name":"On Demand Core"},{"InstanceCount":1,"EbsConfiguration":{"EbsBlockDeviceConfigs":[{"VolumeSpecification":{"SizeInGB":800,"VolumeType":"gp2"},"VolumesPerInstance":1}],"EbsOptimized":true},"InstanceGroupType":"MASTER","InstanceType":"'$machine_type'","Name":"Master"}]' --bootstrap-actions '[{"Path":"s3://mw.test/krish/anovos/general/resources/bootstrapping/req_packages_anovos_3_8.sh","Name":"python"}]' --ebs-root-volume-size 20 --service-role emr-defaultrole --enable-debugging --name 'anovos_time_stat_functions' --scale-down-behavior TERMINATE_AT_TASK_COMPLETION --region us-east-1 > cluster_details.txt

clusterid=`cat cluster_details.txt|/usr/bin/jq ".ClusterId" |sed 's/"//g'`
echo "$clusterid"